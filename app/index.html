<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINE TO DINE Post Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&family=Roboto:wght@300;400;500;700&family=Roboto+Flex:opsz,wght@8..144,300;8..144,400;8..144,500;8..144,600;8..144,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <style>
        /* 2025 CSS Custom Properties mit logischer Hierarchie */
        :root {
            /* FINE TO DINE Corporate Identity 2025 */
            --ftd-primary: #8B1538;
            --ftd-primary-hover: #A8203E;
            --ftd-primary-pressed: #73122C;
            --ftd-secondary: #2C1810;
            --ftd-accent: #D4AF37;
            --ftd-accent-light: #E5C44A;
            
            /* Semantic color tokens */
            --surface-primary: #FFFFFF;
            --surface-secondary: #FAFAFA;
            --surface-tertiary: #F5F5F5;
            --text-primary: var(--ftd-secondary);
            --text-secondary: #6B5B47;
            --text-inverse: var(--surface-primary);
            
            /* Modern spacing scale */
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --space-3xl: 4rem;
            
            /* Typography scale */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            
            /* Modern border radius */
            --radius-xs: 0.25rem;
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-2xl: 2rem;
            
            /* Elevation shadows 2025 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Animation easing 2025 */
            --ease-in: cubic-bezier(0.4, 0, 1, 1);
            --ease-out: cubic-bezier(0, 0, 0.2, 1);
            --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-spring: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* Modern CSS Reset 2025 */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
        }
        
        html {
            height: 100%;
            font-size: 100%;
            -webkit-text-size-adjust: 100%;
            hanging-punctuation: first last;
        }
        
        body {
            min-height: 100%;
            line-height: 1.5;
            font-family: 'Roboto Flex', 'Roboto', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, var(--surface-primary) 0%, var(--surface-secondary) 100%);
            color: var(--text-primary);
        }
        
        img,
        picture,
        video,
        canvas,
        svg {
            display: block;
            max-width: 100%;
        }
        
        input,
        button,
        textarea,
        select {
            font: inherit;
        }
        
        p,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            overflow-wrap: break-word;
        }
        
        /* Loading Screen */
        .auth-loading {
            position: fixed;
            inset: 0;
            background: var(--surface-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: var(--space-lg);
            z-index: 1000;
        }
        
        .auth-loading.hidden {
            display: none;
        }
        
        .loading-icon {
            background: linear-gradient(135deg, var(--ftd-primary) 0%, var(--ftd-primary-hover) 100%);
            border-radius: var(--radius-xl);
            width: 5rem;
            height: 5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-size: 2.5rem;
            box-shadow: var(--shadow-lg);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .loading-text {
            font-family: 'Playfair Display', serif;
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--ftd-primary);
            margin-bottom: var(--space-sm);
        }
        
        .loading-spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid color-mix(in srgb, var(--ftd-primary) 20%, transparent);
            border-top: 3px solid var(--ftd-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Main App Container */
        .app-container {
            container-type: inline-size;
            container-name: app-layout;
            max-width: 75rem;
            margin: 0 auto;
            padding: var(--space-lg);
            min-height: 100vh;
            min-height: 100dvh;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            transition: all 600ms var(--ease-out);
        }
        
        .app-container.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* User Info Header */
        .user-header {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: rgba(255, 255, 255, 0.95);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid color-mix(in srgb, var(--ftd-primary) 10%, transparent);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        
        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: 2px solid var(--ftd-primary);
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        
        .user-name {
            font-weight: 500;
            font-size: var(--text-sm);
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .user-email {
            font-size: var(--text-xs);
            color: var(--text-secondary);
            line-height: 1.2;
        }
        
        .logout-button {
            background: var(--surface-primary);
            color: var(--ftd-primary);
            border: 1px solid var(--ftd-primary);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms var(--ease-out);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .logout-button:hover {
            background: var(--ftd-primary);
            color: var(--text-inverse);
        }
        
        /* Container Queries Setup 2025 */
        .main-grid {
            container-type: inline-size;
            container-name: main-grid;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-2xl);
            align-items: start;
            margin-top: var(--space-3xl);
        }
        
        @container app-layout (inline-size <= 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: var(--space-xl);
                margin-top: var(--space-2xl);
            }
            
            .user-header {
                position: static;
                margin-bottom: var(--space-lg);
                justify-content: center;
            }
        }
        
        /* Cards */
        .card {
            container-type: inline-size;
            container-name: card;
            background: var(--surface-primary);
            border-radius: var(--radius-2xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid color-mix(in srgb, var(--ftd-primary) 5%, transparent);
            transition: all 300ms var(--ease-out);
        }
        
        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }
        
        /* Header Section */
        .header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-2xl);
        }
        
        .header-icon {
            background: linear-gradient(135deg, var(--ftd-primary) 0%, var(--ftd-primary-hover) 100%);
            border-radius: var(--radius-xl);
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-size: 1.75rem;
            box-shadow: var(--shadow-md);
        }
        
        .header-text h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: clamp(var(--text-xl), 4cqi + 1rem, var(--text-3xl));
            color: var(--ftd-primary);
            margin-bottom: 0.25rem;
            letter-spacing: -0.025em;
        }
        
        .header-text p {
            color: var(--text-secondary);
            font-size: var(--text-base);
            font-weight: 400;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: var(--space-xl);
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            font-size: var(--text-base);
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }
        
        .form-textarea {
            width: 100%;
            height: 300px;
            max-height: 400px;
            padding: var(--space-lg);
            border: 2px solid color-mix(in srgb, var(--ftd-primary) 15%, transparent);
            border-radius: var(--radius-xl);
            font-family: 'Roboto', sans-serif;
            font-size: var(--text-base);
            line-height: 1.5;
            color: var(--text-primary);
            background: var(--surface-primary);
            transition: all 200ms var(--ease-out);
            resize: vertical;
            overflow-y: auto;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: var(--ftd-primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--ftd-primary) 12%, transparent);
        }
        
        .form-textarea::placeholder {
            color: var(--text-secondary);
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--ftd-primary) 0%, var(--ftd-primary-hover) 100%);
            color: var(--text-inverse);
            border: none;
            padding: var(--space-lg) var(--space-xl);
            border-radius: var(--radius-xl);
            font-family: 'Roboto', sans-serif;
            font-size: var(--text-base);
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms var(--ease-out);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            width: 100%;
            min-height: 3.5rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--ftd-primary-hover) 0%, var(--ftd-primary-pressed) 100%);
            opacity: 0;
            transition: opacity 200ms var(--ease-out);
            z-index: -1;
        }
        
        .btn-primary:hover:not(:disabled)::before {
            opacity: 1;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:disabled::before {
            opacity: 0;
        }
        
        .btn-secondary {
            background: var(--surface-primary);
            color: var(--ftd-primary);
            border: 1px solid var(--ftd-primary);
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-xl);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 200ms var(--ease-out);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .btn-secondary:hover {
            background: var(--ftd-primary);
            color: var(--text-inverse);
            transform: translateY(-1px);
        }
        
        .btn-icon {
            font-size: 1.25rem;
        }
        
        /* Loading States */
        .loading-state {
            display: none;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            color: var(--text-secondary);
            font-size: var(--text-sm);
            margin-top: var(--space-md);
        }
        
        .loading-state.active {
            display: flex;
        }
        
        /* Result Section */
        .result-card {
            opacity: 0;
            transform: translateY(20px);
            transition: all 500ms var(--ease-spring);
        }
        
        .result-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .result-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        
        .result-icon {
            background: linear-gradient(135deg, var(--ftd-accent) 0%, var(--ftd-accent-light) 100%);
            border-radius: var(--radius-md);
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 1.25rem;
        }
        
        .result-title {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .result-content {
            background: var(--surface-secondary);
            border: 1px solid color-mix(in srgb, var(--ftd-primary) 10%, transparent);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            font-size: var(--text-base);
            line-height: 1.6;
            white-space: pre-wrap;
            margin-bottom: var(--space-lg);
            font-family: 'Roboto', sans-serif;
        }
        
        .result-actions {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }
        
        /* Error Messages */
        .error-message {
            background: color-mix(in srgb, #ef4444 10%, var(--surface-primary));
            color: #dc2626;
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            margin-top: var(--space-md);
            font-size: var(--text-sm);
            border: 1px solid color-mix(in srgb, #ef4444 20%, transparent);
            display: none;
        }
        
        .error-message.active {
            display: block;
            animation: slideIn 300ms var(--ease-out);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Success Animation */
        .success-animation {
            animation: success-bounce 0.6s var(--ease-spring);
        }
        
        @keyframes success-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 480px) {
            .app-container {
                padding: var(--space-md);
            }
            
            .card {
                padding: var(--space-lg);
            }
            
            .user-header {
                position: static;
                margin-bottom: var(--space-lg);
            }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        @media (prefers-contrast: high) {
            .card {
                border: 2px solid var(--text-primary);
            }
            
            .btn-primary {
                border: 2px solid var(--text-inverse);
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --surface-primary: #1a1a1a;
                --surface-secondary: #262626;
                --surface-tertiary: #404040;
                --text-primary: #f5f5f5;
                --text-secondary: #d4d4d4;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Loading Screen -->
    <div id="authLoading" class="auth-loading">
        <div class="loading-icon">
            <span class="material-symbols-outlined">restaurant</span>
        </div>
        <div class="loading-text">FINE TO DINE</div>
        <div class="loading-spinner"></div>
        <p style="color: var(--text-secondary); font-size: var(--text-sm);">Authentifizierung wird überprüft...</p>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="app-container">
        <!-- User Header -->
        <header id="userHeader" class="user-header">
            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
            <div class="user-info">
                <div id="userName" class="user-name"></div>
                <div id="userEmail" class="user-email"></div>
            </div>
            <button id="logoutButton" class="logout-button">
                <span class="material-symbols-outlined" style="font-size: 1rem;">logout</span>
                <span>Abmelden</span>
            </button>
        </header>

        <div class="main-grid">
            <!-- Input Section -->
            <div class="card">
                <div class="header">
                    <div class="header-icon">
                        <span class="material-symbols-outlined">restaurant</span>
                    </div>
                    <div class="header-text">
                        <h1>FINE TO DINE</h1>
                        <p>Social Media Post Generator</p>
                    </div>
                </div>

                <form id="postForm">
                    <div class="form-group">
                        <label for="magazinText" class="form-label">Restaurant-Artikel eingeben</label>
                        <textarea 
                            id="magazinText" 
                            name="magazinText" 
                            class="form-textarea" 
                            placeholder="Fügen Sie hier den Restaurant-Artikel aus dem FINE TO DINE Magazin ein...&#10;&#10;Beispiel: Restaurant LEO in Neftenbach. Küchenchef Kevin Della Rosa bietet marktfrische Küche mit regionalen Produkten..."
                            required></textarea>
                    </div>

                    <button type="submit" class="btn-primary">
                        <span class="material-symbols-outlined btn-icon">auto_awesome</span>
                        <span>Post generieren</span>
                    </button>

                    <div class="loading-state" id="loadingState">
                        <div class="loading-spinner"></div>
                        <span>Generiere Post mit Claude Sonnet 4...</span>
                    </div>

                    <div class="error-message" id="errorMessage"></div>
                </form>
            </div>

            <!-- Result Section -->
            <div class="card result-card" id="resultCard">
                <div class="result-header">
                    <div class="result-icon">
                        <span class="material-symbols-outlined">check_circle</span>
                    </div>
                    <h2 class="result-title">Generierter Social Media Post</h2>
                </div>

                <div class="result-content" id="resultContent">
                    Hier erscheint Ihr generierter Post...
                </div>

                <div class="result-actions">
                    <button class="btn-secondary" onclick="copyToClipboard()">
                        <span class="material-symbols-outlined">content_copy</span>
                        <span>Kopieren</span>
                    </button>
                    <button class="btn-secondary" onclick="sharePost()">
                        <span class="material-symbols-outlined">share</span>
                        <span>Teilen</span>
                    </button>
                    <button class="btn-secondary" onclick="newPost()">
                        <span class="material-symbols-outlined">refresh</span>
                        <span>Neuer Post</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script type="module">
        // FIXED: Auth0 State Problem gelöst
        class ProtectedApp {
            #auth0Client = null;
            #user = null;
            #config = {
                domain: 'dev-j7lkspndihsozye4.auth0.com',
                clientId: 'a8wqmdKF8QgorCzddR6mFmdSdQCf0vma',
                authorizationParams: {
                    redirect_uri: `${window.location.origin}/app/`
                },
                // CRITICAL: Cache location für State persistence
                cacheLocation: 'localstorage',
                useRefreshTokens: true
            };
            
            constructor() {
                this.#initializeAuth();
                this.#bindEvents();
            }
            
            async #initializeAuth() {
                try {
                    console.log('🚀 Starting app initialization...');
                    console.log('Current URL:', window.location.href);
                    
                    this.#auth0Client = await auth0.createAuth0Client(this.#config);
                    console.log('✅ Auth0 client created');
                    
                    // Handle OAuth callback mit verbesserter Error-Behandlung
                    if (window.location.search.includes('code=')) {
                        console.log('🔄 Handling OAuth callback...');
                        try {
                            await this.#auth0Client.handleRedirectCallback();
                            console.log('✅ Callback handled successfully');
                            // Clean URL after successful callback
                            window.history.replaceState({}, document.title, window.location.pathname);
                        } catch (callbackError) {
                            console.error('❌ Callback handling failed:', callbackError);
                            
                            // Bei State-Error: Force neu-authentifizierung
                            if (callbackError.message.includes('Invalid state') || callbackError.message.includes('state')) {
                                console.log('🔧 State error detected - forcing re-authentication');
                                // URL cleanen
                                window.history.replaceState({}, document.title, window.location.pathname);
                                // Cache clearen
                                await this.#clearAuth0Cache();
                                // Force login
                                this.#redirectToLogin();
                                return;
                            }
                            throw callbackError;
                        }
                    }
                    
                    // Check authentication status
                    console.log('🔐 Checking authentication status...');
                    if (await this.#auth0Client.isAuthenticated()) {
                        console.log('✅ User is authenticated');
                        this.#user = await this.#auth0Client.getUser();
                        this.#showApp();
                    } else {
                        console.log('❌ User not authenticated - redirecting to login');
                        this.#redirectToLogin();
                    }
                } catch (error) {
                    console.error('💥 Auth0 initialization failed:', error);
                    await this.#clearAuth0Cache();
                    this.#redirectToLogin();
                }
            }
            
            async #clearAuth0Cache() {
                try {
                    // Auth0 cache clearen
                    const auth0Keys = Object.keys(localStorage).filter(key => 
                        key.startsWith('@@auth0spajs@@') || key.includes('auth0')
                    );
                    auth0Keys.forEach(key => localStorage.removeItem(key));
                    
                    // Session storage auch clearen
                    const sessionKeys = Object.keys(sessionStorage).filter(key => 
                        key.startsWith('@@auth0spajs@@') || key.includes('auth0')
                    );
                    sessionKeys.forEach(key => sessionStorage.removeItem(key));
                    
                    console.log('🧹 Auth0 cache cleared');
                } catch (error) {
                    console.error('Error clearing cache:', error);
                }
            }
            
            #showApp() {
                document.getElementById('authLoading').classList.add('hidden');
                document.getElementById('mainApp').classList.add('visible');
                this.#loadUserProfile();
            }
            
            #redirectToLogin() {
                if ('navigation' in window) {
                    window.navigation.navigate('/login.html');
                } else {
                    window.location.href = '/login.html';
                }
            }
            
            #loadUserProfile() {
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                const userEmail = document.getElementById('userEmail');
                
                if (this.#user) {
                    userAvatar.src = this.#user.picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.#user.name || this.#user.email)}&background=8B1538&color=fff`;
                    userName.textContent = this.#user.name || this.#user.email;
                    userEmail.textContent = this.#user.email;
                }
            }
            
            #bindEvents() {
                // Logout functionality
                document.getElementById('logoutButton')?.addEventListener('click', async () => {
                    await this.#clearAuth0Cache();
                    this.#auth0Client?.logout({
                        logoutParams: {
                            returnTo: `${window.location.origin}/login.html`
                        }
                    });
                });
                
                // Form submission
                document.getElementById('postForm')?.addEventListener('submit', (e) => this.#handleFormSubmit(e));
            }
            
            async #handleFormSubmit(event) {
                event.preventDefault();
                
                const magazinText = document.getElementById('magazinText')?.value.trim();
                if (!magazinText) {
                    this.#showError('Bitte geben Sie einen Restaurant-Artikel ein.');
                    return;
                }
                
                const submitButton = document.querySelector('button[type="submit"]');
                const loadingState = document.getElementById('loadingState');
                const resultCard = document.getElementById('resultCard');
                const errorMessage = document.getElementById('errorMessage');
                
                // UI Updates
                submitButton.disabled = true;
                loadingState?.classList.add('active');
                resultCard?.classList.remove('visible');
                errorMessage?.classList.remove('active');
                
                try {
                    // Get Auth0 token for secure API call
                    const token = await this.#auth0Client.getTokenSilently();
                    
                    const response = await fetch('/.netlify/functions/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ magazinText })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('resultContent').textContent = data.content;
                        resultCard?.classList.add('visible');
                        resultCard?.classList.add('success-animation');
                        
                        // Remove animation class after completion
                        setTimeout(() => {
                            resultCard?.classList.remove('success-animation');
                        }, 600);
                    } else {
                        this.#showError(data.error || 'Ein Fehler ist aufgetreten.');
                    }
                } catch (error) {
                    console.error('Post generation failed:', error);
                    this.#showError('Verbindungsfehler. Bitte versuchen Sie es erneut.');
                } finally {
                    submitButton.disabled = false;
                    loadingState?.classList.remove('active');
                }
            }
            
            #showError(message) {
                const errorElement = document.getElementById('errorMessage');
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.add('active');
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        errorElement.classList.remove('active');
                    }, 5000);
                }
            }
        }
        
        // Utility Functions (Global for onclick handlers)
        window.copyToClipboard = async function() {
            const content = document.getElementById('resultContent')?.textContent;
            if (!content) return;
            
            try {
                await navigator.clipboard.writeText(content);
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined">done</span><span>Kopiert!</span>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            } catch (error) {
                console.error('Copy failed:', error);
            }
        };
        
        window.sharePost = function() {
            const content = document.getElementById('resultContent')?.textContent;
            if (!content) return;
            
            if (navigator.share) {
                navigator.share({
                    title: 'FINE TO DINE Social Media Post',
                    text: content
                }).catch(console.error);
            } else {
                window.copyToClipboard();
            }
        };
        
        window.newPost = function() {
            const magazinText = document.getElementById('magazinText');
            const resultCard = document.getElementById('resultCard');
            const errorMessage = document.getElementById('errorMessage');
            
            if (magazinText) magazinText.value = '';
            resultCard?.classList.remove('visible');
            errorMessage?.classList.remove('active');
            magazinText?.focus();
        };
        
        // Initialize App
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => new ProtectedApp());
        } else {
            new ProtectedApp();
        }
    </script>
</body>
</html>